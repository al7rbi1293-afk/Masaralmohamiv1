# القضايا الخاصة (Private Matters)

هذه الوثيقة تشرح قواعد الخصوصية وإدارة أعضاء القضايا الخاصة داخل المنصة.

## من يقدر يدير أعضاء القضية الخاصة؟

يمكن إضافة/إزالة الأعضاء فقط إذا كانت القضية **خاصة** (`is_private = true`) وكنت:

- شريك/مالك المكتب (`owner`)، أو
- المسؤول عن القضية (`assigned_user_id`)

بالإضافة إلى ذلك: يجب أن تكون قادرًا على **عرض القضية** أصلًا (قواعد RLS تمنع الوصول لغير المصرّح لهم).

## حماية "آخر عضو"

لا يمكن إزالة **آخر عضو** من القضية الخاصة.

- API يمنع العملية ويعيد `409` مع الرسالة:
  - `لا يمكن إزالة آخر عضو من القضية الخاصة.`

## نقاط فنية

- المسارات:
  - `GET /app/api/matters/<id>/members`
  - `POST /app/api/matters/<id>/members/add`
  - `POST /app/api/matters/<id>/members/remove`
- الإضافة/الإزالة مقيّدة بـ Rate Limit (حماية بسيطة ضد الإساءة).
- يتم تسجيل الأحداث في `audit_logs`:
  - `matter.member_added`
  - `matter.member_removed`

## خطوات اختبار يدوية

1. أنشئ عميل ثم قضية جديدة واجعلها "قضية خاصة".
2. افتح القضية > تبويب "ملخص" > بطاقة "الأعضاء المصرح لهم".
3. تأكد أن:
   - الشريك (Owner) يرى زر إضافة/إزالة.
   - العضو العادي يرى القائمة فقط بدون أدوات إدارة.
4. أضف عضوًا جديدًا وتأكد من ظهور اسمه/بريده.
5. حاول إزالة آخر عضو (عندما يكون عدد الأعضاء 1) وتأكد أنها تُمنع برسالة واضحة.

