generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  PARTNER
  LAWYER
  ASSISTANT
}

enum Language {
  AR
  EN
}

enum MatterStatus {
  OPEN
  IN_PROGRESS
  ON_HOLD
  CLOSED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
}

enum InvoiceStatus {
  UNPAID
  PAID
  VOID
}

model Tenant {
  id            String   @id @default(uuid()) @db.Uuid @map("tenant_id")
  firmName      String   @map("firm_name")
  logoUrl       String?  @map("logo_url")
  language      Language @default(AR)
  hijriDisplay  Boolean  @default(true) @map("hijri_display")
  retentionDays Int      @default(3650) @map("retention_days")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  users             User[]
  refreshTokens     RefreshToken[]
  clients           Client[]
  matters           Matter[]
  matterMembers     MatterMember[]
  timelineEvents    MatterTimelineEvent[]
  documentFolders   DocumentFolder[]
  documents         Document[]
  documentVersions  DocumentVersion[]
  documentShares    DocumentShareToken[]
  tasks             Task[]
  billingQuotes     BillingQuote[]
  invoices          Invoice[]
  auditLogs         AuditLog[]

  @@map("tenants")
}

model User {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @db.Uuid @map("tenant_id")
  name         String
  email        String
  passwordHash String   @map("password_hash")
  role         Role
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  tenant             Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  refreshTokens      RefreshToken[]
  assignedMatters    Matter[]             @relation("MatterAssignee")
  matterMemberships  MatterMember[]
  timelineEvents     MatterTimelineEvent[] @relation("TimelineActor")
  createdDocuments   Document[]           @relation("DocumentCreator")
  uploadedVersions   DocumentVersion[]    @relation("DocumentUploader")
  createdShares      DocumentShareToken[] @relation("DocumentShareCreator")
  assignedTasks      Task[]               @relation("TaskAssignee")
  createdTasks       Task[]               @relation("TaskCreator")
  createdQuotes      BillingQuote[]       @relation("QuoteCreator")
  createdInvoices    Invoice[]            @relation("InvoiceCreator")
  auditLogs          AuditLog[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("users")
}

model RefreshToken {
  id        String    @id @default(uuid()) @db.Uuid
  tenantId  String    @db.Uuid @map("tenant_id")
  userId    String    @db.Uuid @map("user_id")
  tokenHash String    @map("token_hash")
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime  @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@map("refresh_tokens")
}

model Client {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @db.Uuid @map("tenant_id")
  name       String
  email      String?
  phone      String?
  notes      String?
  isArchived Boolean  @default(false) @map("is_archived")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  matters       Matter[]
  billingQuotes BillingQuote[]
  invoices      Invoice[]
  documents     Document[]

  @@index([tenantId])
  @@index([tenantId, name])
  @@index([tenantId, isArchived])
  @@map("clients")
}

model Matter {
  id          String      @id @default(uuid()) @db.Uuid
  tenantId    String      @db.Uuid @map("tenant_id")
  clientId    String      @db.Uuid @map("client_id")
  title       String
  description String?
  status      MatterStatus @default(OPEN)
  assigneeId  String?     @db.Uuid @map("assignee_id")
  isPrivate   Boolean     @default(false) @map("is_private")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  tenant      Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client      Client               @relation(fields: [clientId], references: [id], onDelete: Cascade)
  assignee    User?                @relation("MatterAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  members     MatterMember[]
  timeline    MatterTimelineEvent[]
  documents   Document[]
  tasks       Task[]
  billingQuotes BillingQuote[]
  invoices    Invoice[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, updatedAt])
  @@map("matters")
}

model MatterMember {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  matterId  String   @db.Uuid @map("matter_id")
  userId    String   @db.Uuid @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  matter Matter @relation(fields: [matterId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, matterId, userId])
  @@index([tenantId])
  @@index([tenantId, matterId])
  @@map("matter_members")
}

model MatterTimelineEvent {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  matterId  String   @db.Uuid @map("matter_id")
  actorId   String?  @db.Uuid @map("actor_id")
  type      String
  payload   Json?
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  matter Matter @relation(fields: [matterId], references: [id], onDelete: Cascade)
  actor  User?  @relation("TimelineActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, matterId, createdAt])
  @@map("matter_timeline_events")
}

model DocumentFolder {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  name      String
  parentId  String?  @db.Uuid @map("parent_id")
  createdAt DateTime @default(now()) @map("created_at")

  tenant    Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parent    DocumentFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children  DocumentFolder[] @relation("FolderHierarchy")
  documents Document[]

  @@index([tenantId])
  @@index([tenantId, parentId])
  @@map("document_folders")
}

model Document {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @db.Uuid @map("tenant_id")
  matterId    String?  @db.Uuid @map("matter_id")
  clientId    String?  @db.Uuid @map("client_id")
  folderId    String?  @db.Uuid @map("folder_id")
  title       String
  isArchived  Boolean  @default(false) @map("is_archived")
  createdById String   @db.Uuid @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tenant      Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  matter      Matter?              @relation(fields: [matterId], references: [id], onDelete: SetNull)
  client      Client?              @relation(fields: [clientId], references: [id], onDelete: SetNull)
  folder      DocumentFolder?      @relation(fields: [folderId], references: [id], onDelete: SetNull)
  createdBy   User                 @relation("DocumentCreator", fields: [createdById], references: [id], onDelete: Restrict)
  versions    DocumentVersion[]
  shareTokens DocumentShareToken[]

  @@index([tenantId])
  @@index([tenantId, matterId])
  @@index([tenantId, clientId])
  @@index([tenantId, folderId])
  @@map("documents")
}

model DocumentVersion {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @db.Uuid @map("tenant_id")
  documentId   String   @db.Uuid @map("document_id")
  version      Int
  storageKey   String   @map("storage_key")
  mimeType     String   @map("mime_type")
  size         Int
  tags         String[] @default([])
  uploadedById String   @db.Uuid @map("uploaded_by_id")
  createdAt    DateTime @default(now()) @map("created_at")

  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  uploadedBy User     @relation("DocumentUploader", fields: [uploadedById], references: [id], onDelete: Restrict)

  @@unique([tenantId, documentId, version])
  @@index([tenantId])
  @@index([tenantId, documentId])
  @@map("document_versions")
}

model DocumentShareToken {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @db.Uuid @map("tenant_id")
  documentId  String    @db.Uuid @map("document_id")
  token       String    @unique
  expiresAt   DateTime  @map("expires_at")
  createdById String    @db.Uuid @map("created_by_id")
  revokedAt   DateTime? @map("revoked_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document  Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  createdBy User     @relation("DocumentShareCreator", fields: [createdById], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([tenantId, expiresAt])
  @@index([tenantId, documentId])
  @@map("document_share_tokens")
}

model Task {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @db.Uuid @map("tenant_id")
  title       String
  description String?
  status      TaskStatus @default(TODO)
  dueDate     DateTime? @map("due_date")
  reminderAt  DateTime? @map("reminder_at")
  assigneeId  String?   @db.Uuid @map("assignee_id")
  matterId    String?   @db.Uuid @map("matter_id")
  createdById String    @db.Uuid @map("created_by_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  tenant    Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignee  User?   @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  matter    Matter? @relation(fields: [matterId], references: [id], onDelete: SetNull)
  createdBy User    @relation("TaskCreator", fields: [createdById], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([tenantId, status, dueDate])
  @@index([tenantId, reminderAt])
  @@map("tasks")
}

model BillingQuote {
  id          String     @id @default(uuid()) @db.Uuid
  tenantId    String     @db.Uuid @map("tenant_id")
  clientId    String     @db.Uuid @map("client_id")
  matterId    String?    @db.Uuid @map("matter_id")
  number      String
  status      QuoteStatus @default(DRAFT)
  subtotal    Decimal    @db.Decimal(12, 2)
  tax         Decimal    @db.Decimal(12, 2)
  total       Decimal    @db.Decimal(12, 2)
  createdById String     @db.Uuid @map("created_by_id")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  matter    Matter?  @relation(fields: [matterId], references: [id], onDelete: SetNull)
  createdBy User     @relation("QuoteCreator", fields: [createdById], references: [id], onDelete: Restrict)
  invoice   Invoice?

  @@unique([tenantId, number])
  @@index([tenantId])
  @@index([tenantId, status])
  @@map("billing_quotes")
}

model Invoice {
  id          String       @id @default(uuid()) @db.Uuid
  tenantId    String       @db.Uuid @map("tenant_id")
  clientId    String       @db.Uuid @map("client_id")
  matterId    String?      @db.Uuid @map("matter_id")
  quoteId     String?      @unique @db.Uuid @map("quote_id")
  number      String
  status      InvoiceStatus @default(UNPAID)
  issuedAt    DateTime     @default(now()) @map("issued_at")
  dueAt       DateTime?    @map("due_at")
  paidAt      DateTime?    @map("paid_at")
  subtotal    Decimal      @db.Decimal(12, 2)
  tax         Decimal      @db.Decimal(12, 2)
  total       Decimal      @db.Decimal(12, 2)
  createdById String       @db.Uuid @map("created_by_id")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  tenant    Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client    Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  matter    Matter?      @relation(fields: [matterId], references: [id], onDelete: SetNull)
  quote     BillingQuote? @relation(fields: [quoteId], references: [id], onDelete: SetNull)
  createdBy User         @relation("InvoiceCreator", fields: [createdById], references: [id], onDelete: Restrict)

  @@unique([tenantId, number])
  @@index([tenantId])
  @@index([tenantId, status])
  @@map("invoices")
}

model AuditLog {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  userId    String?  @db.Uuid @map("user_id")
  action    String
  entity    String
  entityId  String?  @map("entity_id")
  ip        String?
  userAgent String?  @map("user_agent")
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, action])
  @@index([tenantId, createdAt])
  @@map("audit_logs")
}
