# Performance Budgets (Phase 9.3.1)

هذه الميزانيات (Budgets) هدفها منع “الاستعلامات الثقيلة” والصفحات التي تُحمّل بيانات أكثر من اللازم، خصوصًا مع أول 10 مكاتب.

## 1) حدود القوائم (Pagination)

- القوائم الأساسية تستخدم ترقيم صفحات (page/limit) دائمًا.
- حد `limit` الأقصى:
  - العملاء/القضايا/المهام/الفوترة: `<= 50`
  - المستندات: `<= 50` (الافتراضي `10`)
- الهدف: لا توجد صفحة قائمة تُحمّل “كل البيانات” في طلب واحد.

## 2) البحث (Global Search)

- حد الاستعلام:
  - `min: 2` أحرف
  - `max: 80` حرف
- حد النتائج:
  - `<= 10` عناصر لكل مجموعة (عملاء/قضايا/مستندات/مهام)

## 3) ميزانية Endpoints الثقيلة

### أ) تصدير PDF للفواتير

- الهدف: < 2 ثوانٍ في الفواتير الصغيرة (<= 20 بند).
- حماية وقت التنفيذ (Fail fast):
  - Timeout: `8s`
  - Circuit breaker: يفتح بعد `3` أخطاء متتالية لمدة `30s`
- في حال الفشل المؤقت: يرجع 503 برسالة عربية.

### ب) توليد روابط التخزين الموقعة (Signed URLs)

- الهدف: < 1 ثانية.
- حماية وقت التنفيذ:
  - Timeout: `6s` للتنزيل، `8s` للرفع
  - Circuit breaker: `3` أخطاء متتالية → `30s`
- في حال الفشل المؤقت: يرجع 503 برسالة عربية.

## 4) تجنب Overfetch

- في قائمة المستندات: يتم جلب **آخر نسخة فقط لكل مستند** (بدلاً من تحميل جميع النسخ).
- تجنب `select *` في PostgREST: استخدم تحديد الأعمدة المطلوبة فقط.

## 5) ملاحظات تشغيلية

- هذه الحمايات تعتمد على ذاكرة العملية (in-memory) وقد تُعاد تهيئتها مع بيئات Serverless، لكنها تقلل الأعطال المتسلسلة داخل نفس الـruntime.
- أي تحسينات فهرسة إضافية يجب أن تكون “محددة” وتخدم ترتيب القوائم الأكثر استخدامًا فقط.

